<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLTFLoader</title>
    <style>
        body { 
            margin: 0;
	    background-color: black;
        }
        
        #three-area {
            image-rendering: pixelated;
            zoom: 4;
        }
    </style>
</head>

<body>
    <div id="three-area"></div>
</body>

<script src="scripts/cannon.js"></script>
<script src="scripts/three.js"></script>
<script src="scripts/GLTFLoader.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

<script>
    //Cannon settings:
    var world = new CANNON.World();
    world.broadphase = new CANNON.SAPBroadphase(world);
    world.gravity.set(0, 0, -10);
    world.defaultContactMaterial.friction = 0.0001;



    var groundMaterial = new CANNON.Material("groundMaterial");
    var wheelMaterial = new CANNON.Material("wheelMaterial");
    var wheelGroundContactMaterial = new CANNON.ContactMaterial(wheelMaterial, groundMaterial, {
        friction: 1000,
        restitution: 10,
        contactEquationStiffness: 10
    });

    var carMaterial = new CANNON.Material("carMaterial");
    var carMaterialContactMaterial = new CANNON.ContactMaterial(carMaterial, carMaterial, {
        friction: 1,
        restitution: 10,
        contactEquationStiffness: 10
    });

    var carGroundMaterialContactMaterial = new CANNON.ContactMaterial(carMaterial, groundMaterial, {
        friction: 1000,
        restitution: 10,
        contactEquationStiffness: 10
    });


    var chassisShape;
    chassisShape = new CANNON.Box(new CANNON.Vec3(2.65, 2,.5));
    var chassisBody = new CANNON.Body({ mass: 500 });
    chassisBody.addShape(chassisShape);
    chassisBody.position.set(0, 0, 10);

    var options = {
                    radius: 10,
                    directionLocal: new CANNON.Vec3(0, 0, -1),
                    suspensionStiffness: 43,
                    suspensionRestLength: 0.4,
                    frictionSlip: 5,
                    dampingRelaxation: 2.9,
                    dampingCompression: 3,
                    maxSuspensionForce: 10,
                    rollInfluence:  0.1,
                    axleLocal: new CANNON.Vec3(0, 1, 0),
                    chassisConnectionPointLocal: new CANNON.Vec3(1, 1, 0),
                    maxSuspensionTravel: 0.2,
                    customSlidingRotationalSpeed: -30,
                    useCustomSlidingRotationalSpeed: true
                };

    vehicle = new CANNON.RaycastVehicle({
        chassisBody: chassisBody,
    });

    options.chassisConnectionPointLocal.set(2, 1.24, .3);
    vehicle.addWheel(options);

    options.chassisConnectionPointLocal.set(2, -1.24, .3);
    vehicle.addWheel(options);

    options.chassisConnectionPointLocal.set(-1.85, 1.3, .3);
    vehicle.addWheel(options);

    options.chassisConnectionPointLocal.set(-1.85, -1.3, .3);
    vehicle.addWheel(options);

    vehicle.addToWorld(world);

    var wheelBodies = [];
    for(var i=0; i<vehicle.wheelInfos.length; i++){
        var wheel = vehicle.wheelInfos[i];
        var cylinderShape = new CANNON.Cylinder(wheel.radius, wheel.radius, .4, 20);
        var wheelBody = new CANNON.Body({ mass: 10 });
        var q = new CANNON.Quaternion();
        q.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), Math.PI / 2);
        wheelBody.addShape(cylinderShape, new CANNON.Vec3(), q);
        wheelBodies.push(wheelBody);
    }

    world.addEventListener('postStep', function(){
        for (var i = 0; i < vehicle.wheelInfos.length; i++) {
            vehicle.updateWheelTransform(i);
            var t = vehicle.wheelInfos[i].worldTransform;
            wheelBodies[i].position.copy(t.position);
            wheelBodies[i].quaternion.copy(t.quaternion);
        }
    });

    
    document.onkeydown = handler;
    document.onkeyup = handler;

    var maxSteerVal = 0.5;
    var maxForce = 2000;
    var brakeForce = 10;
    function handler(event){
        var up = (event.type == 'keyup');

        if(!up && event.type !== 'keydown'){
            return;
        }

        vehicle.setBrake(0, 0);
        vehicle.setBrake(0, 1);
        vehicle.setBrake(0, 2);
        vehicle.setBrake(0, 3);

        switch(event.keyCode){

	// forward
    case 38: // up arrow
	case 87: // w
            vehicle.applyEngineForce(up ? 0 : -maxForce, 2);
            vehicle.applyEngineForce(up ? 0 : -maxForce, 3);
            break;

	// backward
    case 40: // down arrow
	case 83: // s
            vehicle.applyEngineForce(up ? 0 : maxForce, 2);
            vehicle.applyEngineForce(up ? 0 : maxForce, 3);
            break;

	// brake
    case 66: // b
        vehicle.setBrake(brakeForce, 0);
        vehicle.setBrake(brakeForce, 1);
        vehicle.setBrake(brakeForce, 2);
        vehicle.setBrake(brakeForce, 3);
        break;
	
	// right
    case 39: // right arrow
	case 68: // d
            vehicle.setSteeringValue(up ? 0 : -maxSteerVal, 0);
            vehicle.setSteeringValue(up ? 0 : -maxSteerVal, 1);
            break;

	// left
    case 37: // left arrow
	case 65: // a
            vehicle.setSteeringValue(up ? 0 : maxSteerVal, 0);
            vehicle.setSteeringValue(up ? 0 : maxSteerVal, 1);
            break;

        }
    }

    var groundBody = new CANNON.Body({
        mass: 0, // mass: 0 makes the body static
        material: groundMaterial
    });
    var groundShape = new CANNON.Plane();
    groundBody.addShape(groundShape);
    world.addBody(groundBody);

    var fixedTimeStep = 1.0 / 60.0;
    var maxSubSteps = 3;

    var lastTime;
    (function simloop(time){
    requestAnimationFrame(simloop);
    if(lastTime !== undefined){
        var dt = (time - lastTime) / 1000;
        world.step(fixedTimeStep, dt, maxSubSteps);
    }
    lastTime = time;
    })();


    //Three settings:
    const threeDOM = document.getElementById("three-area");
    const scene = new THREE.Scene();

    let carList= [
                {
                    name: "Player",
                    mass: 5000
                },
                {
                    name: "Car1",
                    mass: 5000
                },
                {
                    name: "Car2",
                    mass: 5000
                },
                {
                    name: "Car3",
                    mass: 5000
                },
                {
                    name: "Car4",
                    mass: 5000
                },
                {
                    name: "Car5",
                    mass: 5000
                },
                {
                    name: "Police",
                    mass: 5000
                },
                {
                    name: "Taxi",
                    mass: 5000
                }
            ];
    let carCollections = [...Array(carList.length)].map(e => Array(0));

    const loader = new THREE.GLTFLoader();
    loader.load( 'assets/world.gltf', function ( gltf ) {
        const model = gltf.scene;

        for(child of model.children){
            
            if(child.name.search("Car") == 0){
                for(let i = 0; i < carList.length; i++){
                    let carName = carList[i].name;
                    if(child.name.search("Car" + carName) == 0){
                        carCollections[i].push(child);
                        carCollections[i].name = carName;
                    }
                }
            }
            if(child.name.search("MovementMeshCar") == 0){
                for(let i = 0; i < carList.length; i++){
                    let carName = carList[i].name;
                    if(child.name.search("MovementMeshCar" + carName) == 0){
                        var shape = new CANNON.Box(new CANNON.Vec3(child.scale.x,child.scale.y,child.scale.z));
                        var boxBody = new CANNON.Body({ mass: carList[i].mass, material: carMaterial });
                        boxBody.name = ("MovementMeshCar" + carName);
                        boxBody.addShape(shape);
                        boxBody.position.set(child.position.x,child.position.y,child.position.z);
                        boxBody.quaternion.w = child.quaternion.w;
                        boxBody.quaternion.x = child.quaternion.x;
                        boxBody.quaternion.y = child.quaternion.y;
                        boxBody.quaternion.z = child.quaternion.z;
                        boxBody.updateMassProperties();
                        world.add(boxBody);
                        child.visible = false;
                    }
                }
            } 
            if(child.name.search("MovementMeshTerrain") == 0){
                var shape = new CANNON.Box(new CANNON.Vec3(child.scale.x,child.scale.y,child.scale.z));
                var boxBody = new CANNON.Body({ mass: 0 });
                boxBody.addShape(shape);
                boxBody.position.set(child.position.x,child.position.y,child.position.z);
                boxBody.quaternion.w = child.quaternion.w;
                boxBody.quaternion.x = child.quaternion.x;
                boxBody.quaternion.y = child.quaternion.y;
                boxBody.quaternion.z = child.quaternion.z;
                boxBody.updateMassProperties();
                world.add(boxBody);
                child.visible = false;
            } 
        }
        model.traverse( function( node ) {
            node.castShadow = true;
            node.receiveShadow = true;

        } );
        scene.add( model );

    } );

    const ambientLight = new THREE.AmbientLight( 0xffffff );
    ambientLight.intensity = 4;
    scene.add( ambientLight );

    const light = new THREE.HemisphereLight( 0xffeeff, 0x080820, 2 );
    scene.add( light );
    // scene.fog = new THREE.Fog(0xffeeff, 1, 100);

    const resolution = {x: 160, y: 144};
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize( resolution.x, resolution.y );
    renderer.physicallyCorrectLights = true; //Ensures lights match Blender renders
    renderer.setClearColor( 0xffffff, 0);
    renderer.shadowMap.enabled = true;
    threeDOM.appendChild( renderer.domElement );

    const camera = new THREE.PerspectiveCamera( 45, resolution.x/resolution.y, 1, 200 );
    camera.up.set( 0, 0, 1 );
    camera.position.set( 12, 12, 10 );
    camera.lookAt( 0, 0, 0 );

    const controls = new THREE.OrbitControls( camera, renderer.domElement );

    controls.update();

    function animate() {


        requestAnimationFrame( animate );

        for(let car of carCollections){
            if(car == carCollections[0]){
                for(let item of car){
                    item.quaternion.copy(vehicle.chassisBody.quaternion);
                    item.position.x = vehicle.chassisBody.position.x;
                    item.position.y = vehicle.chassisBody.position.y;
                    item.position.z = vehicle.chassisBody.position.z;

                    if(item.name == "CarPlayerWheel1"){
                        item.quaternion.copy(wheelBodies[0].quaternion);
                        item.position.x = wheelBodies[0].position.x;
                        item.position.y = wheelBodies[0].position.y;
                        item.position.z = wheelBodies[0].position.z;

                    }
                    
                    if(item.name == "CarPlayerWheel2"){
                        item.quaternion.copy(wheelBodies[1].quaternion);
                        item.position.x = wheelBodies[1].position.x;
                        item.position.y = wheelBodies[1].position.y;
                        item.position.z = wheelBodies[1].position.z;
                    }
                    
                    if(item.name == "CarPlayerWheel3"){
                        item.quaternion.copy(wheelBodies[2].quaternion);
                        item.position.x = wheelBodies[2].position.x;
                        item.position.y = wheelBodies[2].position.y;
                        item.position.z = wheelBodies[2].position.z;
                    }
                    
                    if(item.name == "CarPlayerWheel4"){
                        item.quaternion.copy(wheelBodies[3].quaternion);
                        item.position.x = wheelBodies[3].position.x;
                        item.position.y = wheelBodies[3].position.y;
                        item.position.z = wheelBodies[3].position.z;
                    }

                }
            }
            else{
                for(let body of world.bodies){
                    if(body.name == "MovementMeshCar" + car.name){
                        for(let item of car){
                            item.quaternion.copy(body.quaternion);
                            item.rotateX(Math.PI/2);

                            item.position.x = body.position.x;
                            item.position.y = body.position.y;
                            item.position.z = body.position.z;
                        }
                    }
                }
            }
        }

        renderer.render( scene, camera );

    }

    animate();
</script>
</html>